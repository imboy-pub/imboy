map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# 灰度发布配置区域开始 #######################################

# 1. 基于Header的灰度发布映射 (X-Gray-Release: true)
map $http_x_gray_release $gray_by_header {
    default 0;      # 默认不启用灰度
    "true"   1;     # 当请求头包含 X-Gray-Release: true 时启用
    "1"      1;     # 也支持 X-Gray-Release: 1
}

# 2. 基于IP地址的灰度发布映射
geo $gray_by_ip {
    default 0;
    127.0.0.1 1;    # 本地IP总是走灰度
    192.168.1.0/24 1; # 内网特定网段
    # 在此添加更多测试IP或网段
}

# 3. 基于百分比流量的灰度发布 (5%流量走灰度)
split_clients "${remote_addr}${http_user_agent}" $gray_by_percent {
    5%     1;       # 5%的流量分配到灰度
    *      0;       # 其余流量走生产
}

# 4. 基于URL参数的灰度发布 (?gray=true)
map $arg_gray $gray_by_param {
    default 0;
    "true"  1;      # gray=true 时启用
    "1"     1;      # gray=1 时也启用
    "on"    1;      # gray=on 时也启用
}

# 综合判断逻辑：任一条件满足即走灰度
map $gray_by_header$gray_by_ip$gray_by_percent$gray_by_param $gray_env {
    default "production";
    "~*1"   "staging"; # 任一灰度条件为1(true)时使用灰度环境
}

# 定义上游服务器
upstream production {
    server 127.0.0.1:9800;  # 生产环境API端口
}

upstream staging {
    server 127.0.0.1:9801;  # 灰度环境API端口(假设灰度服务运行在9801)
}

# 灰度发布配置区域结束 #######################################

# main api
server
{
    listen [::]:80;
    listen [::]:443 ssl;
    listen 80;
    listen 443 ssl;
    http2 on;
    server_name dev.imboy.pub;
    index index.php index.html index.htm default.php default.htm default.html;
    root /www/wwwroot/dev.imboy.pub;

    # 禁止访问的文件或目录
    location ~ ^/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md)
    {
        return 404;
    }

    # SSL证书验证目录
    location ~ \.well-known{
        allow all;
    }

    error_log /var/log/nginx/api.imboy.pub.error.log;

    # 静态资源处理
    location ^~ /static/ {
        alias /var/local/imboy/apps/imadm/priv/static/;
        expires 30d;
        try_files $uri $uri/ =404;
    }

    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
    {
        expires      30d;
        error_log /dev/null;
        access_log /dev/null;
    }
    
    location ~ .*\.(js|css|ttf|woff|woff2)?$
    {
        expires      12h;
        error_log /dev/null;
        access_log /dev/null;
    }

    client_max_body_size 500M;
    client_body_buffer_size 512k;

    # WebSocket处理
    location /ws/ {
        # 使用灰度判断后的上游
        proxy_pass http://$gray_env/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Sec-WebSocket-Version 13;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 7200s;
        proxy_send_timeout 60s;
        proxy_connect_timeout 10s;
        proxy_buffering off;
    }

    # 后台管理路由
    location /adm/ {
        # 使用灰度判断后的上游
        proxy_pass http://$gray_env/adm/;
        proxy_pass_header Server;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_set_header X-Scheme $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 应用文件路由
    location /app/ {
        autoindex on;
        default_type application/octet-stream;
    }

    # 主路由 - 应用灰度路由逻辑
    location / {
        # 使用灰度判断后的上游
        proxy_pass http://$gray_env;
        proxy_pass_header Server;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_set_header X-Scheme $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 添加灰度标记头到后端(可选)
        proxy_set_header X-Gray-Status $gray_env;
    }

    location ~ /\.ht {
        deny all;
    }
}

# æ¶ˆæ¯ç»“æ„ä½“
```
Msg = {"id":ID, "status":Status, "type":Type, "from":From, "to":To, "payload": Payload, "server_ts": ServerTs}

Msg2 = {"type": "error", "code":Code, "payload": Payload, "server_ts": Ts}
```


## Msg2.error
* Msg2.code = 1 æ— éœ€å¼¹çª—é”™è¯¯ï¼Œå¯ä»¥è®°å½•æ—¥å¿—åç›´æ¥å¿½ç•¥é”™è¯¯ Msg2.payload å¯èƒ½ä¸ºç©ºï¼Œä¸éœ€è¦å¤„ç†
* Msg2.code = 2 å¸¦titleå¼¹çª—ï¼ŒMsg2.payload ä¸èƒ½ä¸ºç©º å¿…é¡»åŒ…å«title contentå­—æ®µ
* Msg2.code = 3 æ— titleå¼¹çª—ï¼ŒMsg2.payload ä¸èƒ½ä¸ºç©º å¿…é¡»åŒ…å« contentå­—æ®µ
* Msg2.code = 705 tokenè¿‡æœŸåˆ·æ–°token
* Msg2.code = 706 tokenæ— æ•ˆ (åŒ…å«ç¼ºå¤±tokenæƒ…å†µ) æˆ–è€…è®¾å¤‡IDä¸å­˜åœ¨ éœ€è¦é‡æ–°ç™»å½•
* Msg2.code = 707 ç­¾åé”™è¯¯ï¼Œéœ€è¦ä¸‹è½½æœ€æ–°ç‰ˆæœ¬APP

# Msg.id
Xid().toString()


# Msg.Type

## å•èŠï¼ˆc2c[any()]ï¼‰
* Msg.Type = <<"C2C">>

## ç¾¤èŠ(c2g[any()])
* Msg.Type = <<"C2G">>

## æ¨é€(S2C)
### Payload.msg_type = logged_another_device
åœ¨å…¶ä»–è®¾å¤‡ç™»å½•äº†, Payload.content = ""

### Payload.msg_type = online
ç”¨æˆ·åœ¨çº¿çŠ¶æ€å˜æ›´, data['from'] ä¸ºå¥½å‹ID

### Payload.msg_type = offline
ç”¨æˆ·åœ¨çº¿çŠ¶æ€å˜æ›´, data['from'] ä¸ºå¥½å‹ID

### Payload.msg_type = hide
ç”¨æˆ·åœ¨çº¿çŠ¶æ€å˜æ›´, data['from'] ä¸ºå¥½å‹ID

### Payload.msg_type = apply_friend
æ·»åŠ å¥½å‹ç”³è¯·, Payload.content = ""

apply_friend
```
{"from":{"source":"qrcode","msg":"æˆ‘æ˜¯ nick leeyiğŸ‘ğŸ»ğŸ‘ğŸ»å°±","remark":"leeyi101","role":"all","donotlookhim":false,"donotlethimlook":true},"to":{},"msg_type":"custom","custom_type":"apply_friend"}
```


### Payload.msg_type = apply_friend_confirm
æ·»åŠ å¥½å‹ç”³è¯·ç¡®è®¤, Payload.content = ""

### Payload.msg_type = user_cancel
* ç”¨æˆ·æ³¨é”€é€šçŸ¥å¥½å‹
* æ¶ˆæ¯å¯èƒ½é‡å¤æŠ•é€’å¤šæ¬¡
* data['from'] ä¸ºå‘èµ·æ³¨é”€çš„ç”¨æˆ·user_idçš„ hashids:encode å€¼ï¼›
* data['to'] ä¸ºæ³¨é”€ç”¨æˆ·çš„å¥½å‹çš„ user_idçš„ hashids:encode å€¼ï¼›

### Payload.msg_type = group_member_join
ç”¨æˆ·åŠ å…¥ç¾¤èŠï¼Œå½“å‰ç”¨æˆ·ä¸ä¼šæ”¶åˆ°è¯¥æ¶ˆæ¯
* æ¶ˆæ¯å¯èƒ½é‡å¤æŠ•é€’å¤šæ¬¡
* data['from'] å‘èµ·ä¸šåŠ¡çš„ç”¨æˆ·user_idçš„ hashids:encode å€¼ï¼›
* data['to'] ä¸ºæ“ä½œå‰æ‰€æœ‰ç¾¤æˆå‘˜çš„ user_idçš„ hashids:encode å€¼ï¼›
* ç¾¤ç»„ä¹Ÿä¼šæ”¶åˆ°è¯¥æ¶ˆæ¯ï¼Œè¯·APPç«¯åšå¿½ç•¥ï¼Œç›´æ¥ack

### Payload.msg_type = group_member_leave
ç”¨æˆ·é€€å‡ºç¾¤èŠåï¼Œå½“å‰ç”¨æˆ·ä¹Ÿä¼šæ”¶åˆ°è¯¥æ¶ˆæ¯ï¼Œè¯·APPç«¯åšå¿½ç•¥ï¼Œç›´æ¥ack
* æ¶ˆæ¯å¯èƒ½é‡å¤æŠ•é€’å¤šæ¬¡
* data['from'] å‘èµ·ä¸šåŠ¡çš„ç”¨æˆ·user_idçš„ hashids:encode å€¼ï¼›
* data['to'] ä¸ºæ“ä½œå‰æ‰€æœ‰ç¾¤æˆå‘˜çš„ user_idçš„ hashids:encode å€¼ï¼›
* ç¾¤ç»„ä¹Ÿä¼šæ”¶åˆ°è¯¥æ¶ˆæ¯ï¼Œè¯·APPç«¯åšå¿½ç•¥ï¼Œç›´æ¥ack

### Payload.msg_type = group_dissolve
ç”¨æˆ·æ³¨é”€é€šçŸ¥å¥½å‹ï¼Œç¾¤ä¸»ä¹Ÿä¼šæ”¶åˆ°è¯¥æ¶ˆæ¯ï¼Œè¯·APPç«¯åšå¿½ç•¥ï¼Œç›´æ¥ack
* æ¶ˆæ¯å¯èƒ½é‡å¤æŠ•é€’å¤šæ¬¡
* data['from'] å‘èµ·ä¸šåŠ¡çš„ç”¨æˆ·user_idçš„ hashids:encode å€¼ï¼›
* data['to'] ä¸ºæ“ä½œå‰æ‰€æœ‰ç¾¤æˆå‘˜çš„ user_idçš„ hashids:encode å€¼ï¼›
*

### Payload.msg_type = group_member_alias
ç”¨æˆ·ä¿®æ”¹ç¾¤å†…æ˜µç§°ç­‰é€šçŸ¥å¥½å‹ï¼Œç¾¤ä¸»ä¹Ÿä¼šæ”¶åˆ°è¯¥æ¶ˆæ¯ï¼Œè¯·APPç«¯åšå¿½ç•¥ï¼Œç›´æ¥ack
* æ¶ˆæ¯å¯èƒ½é‡å¤æŠ•é€’å¤šæ¬¡
* data['from'] å‘èµ·ä¸šåŠ¡çš„ç”¨æˆ·user_idçš„ hashids:encode å€¼ï¼›
* data['to'] ä¸ºæ“ä½œå‰æ‰€æœ‰ç¾¤æˆå‘˜çš„ user_idçš„ hashids:encode å€¼ï¼›
* data['alias'] ä¿®æ”¹åçš„ç¾¤å†…æ˜µç§°
* data['description'] ä¿®æ”¹åçš„ç¾¤å†…ç§’æ•°
* data['updated_at'] ä¿®æ”¹æ˜¯çš„utc0æ¯«ç§’æ—¶é—´æˆ³


## å®¢æˆ·ç«¯ç¡®è®¤æ¶ˆæ¯ CLIENT_ACK
```
% å®¢æˆ·ç«¯ç¡®è®¤æ¶ˆæ¯
websocket_handle({text, <<"CLIENT_ACK", Tail/binary>>}, State) ->
    [Type, MsgId, DID] = binary:split(Tail, <<",">>, [global]),
    ?LOG(["CLIENT_ACK", Tail]),
    CurrentUid = proplists:get_value(current_uid, State),
    case Type of
        <<"C2C">> ->
            websocket_logic:c2c_client_ack(MsgId, CurrentUid, DID),
            {ok, State, hibernate};
        <<"S2C">> ->
            websocket_logic:s2c_client_ack(MsgId, CurrentUid, DID),
            {ok, State, hibernate}
    end;
```

# ServerTs
æœåŠ¡å™¨çš„å½“å‰æ¯«ç§’æ—¶é—´æˆ³
```
 Ts = util_dt:milliseconds(),
```
